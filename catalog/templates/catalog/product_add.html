{% extends 'catalog/base.html' %}
{% load static %}

{% block title %}–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/image-editor.css' %}">
{% endblock %}

{% block header_title %}‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä{% endblock %}

{% block content %}
<div class="form-box">
    <h2>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h2>
    
    <form method="post" enctype="multipart/form-data" data-editor-form>
        {% csrf_token %}
        
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <h3>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
        {{ form.category.label_tag }} {{ form.category }}
        {{ form.material.label_tag }} {{ form.material }}
        {{ form.name.label_tag }} {{ form.name }}
        {{ form.article.label_tag }} {{ form.article }}
        {{ form.description.label_tag }} {{ form.description }}
        
        <!-- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
        <h3>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h3>
        {{ form.weight.label_tag }} {{ form.weight }}
        {{ form.size.label_tag }} {{ form.size }}
        {{ form.has_stones.label_tag }} {{ form.has_stones }}
        {{ form.stone_description.label_tag }} {{ form.stone_description }}
        
        <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∏–∑–¥–µ–ª–∏—è -->
        <h3>üìè –¢–∏–ø –∏–∑–¥–µ–ª–∏—è</h3>
        <div class="form-group">
            {{ form.reference_photo_type.label_tag }}
            {{ form.reference_photo_type }}
            <p class="help-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞ —Ä–∞–∑–º–µ—Ä–æ–≤</p>
        </div>
        
        <!-- –†–µ–¥–∞–∫—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ç–∏–ø) -->
        <div id="editorSection" class="hidden">
            <h3>üìê –ü–æ–¥–≥–æ–Ω–∫–∞ –∏–∑–¥–µ–ª–∏—è –ø–æ–¥ —ç—Ç–∞–ª–æ–Ω</h3>
            
            <div class="image-editor-container" 
                 id="imageEditorContainer"
                 data-reference-image=""
                 data-reference-width="50"
                 data-reference-height="60">
                
                <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
                <div class="editor-instructions">
                    <h4>–ö–∞–∫ –ø–æ–¥–æ–≥–Ω–∞—Ç—å –∏–∑–¥–µ–ª–∏–µ:</h4>
                    <ul>
                        <li>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –≤–∞—à–µ–≥–æ –∏–∑–¥–µ–ª–∏—è</li>
                        <li>–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–π—Ç–µ –µ–≥–æ –º—ã—à–∫–æ–π</li>
                        <li>–ü–æ–¥–≥–æ–Ω–∏—Ç–µ –ø–æ–¥ —ç—Ç–∞–ª–æ–Ω –¥–ª—è —Ç–æ—á–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤</li>
                        <li>–†–∞–∑–º–µ—Ä—ã —Ä–∞—Å—Å—á–∏—Ç–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
                    </ul>
                </div>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —ç—Ç–∞–ª–æ–Ω–µ -->
                <div class="reference-info" id="referenceInfo" style="display:none;">
                    <strong>–≠—Ç–∞–ª–æ–Ω:</strong> <span id="referenceTypeText"></span><br>
                    <strong>–†–∞–∑–º–µ—Ä—ã —ç—Ç–∞–ª–æ–Ω–∞:</strong> <span id="referenceSizeText"></span>
                </div>
                
                <!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã -->
                <div class="editor-controls">
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–¥–µ–ª–∏—è -->
    <div class="file-upload">
        <input type="file" id="productImageInput" accept="image/*">
        <label for="productImageInput" class="file-upload-btn">
            üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –∏–∑–¥–µ–ª–∏—è
        </label>
    </div>
    
    <!-- –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —ç—Ç–∞–ª–æ–Ω–∞ -->
    <div class="control-group">
        <label for="referenceOpacity">–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —ç—Ç–∞–ª–æ–Ω–∞:</label>
        <input type="range" 
               id="referenceOpacity" 
               class="opacity-slider"
               min="0" 
               max="1" 
               step="0.1" 
               value="0.5">
    </div>
    
    <!-- –ù–û–í–´–ô: –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∏–∑–¥–µ–ª–∏—è -->
    <div class="control-group">
        <label for="productOpacity">–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∏–∑–¥–µ–ª–∏—è:</label>
        <input type="range" 
               id="productOpacity" 
               class="opacity-slider"
               min="0" 
               max="1" 
               step="0.1" 
               value="1"
               disabled>
        <span class="opacity-value">100%</span>
    </div>
    
    <!-- Zoom –∫–æ–Ω—Ç—Ä–æ–ª—ã -->
    <div class="zoom-controls">
        <button type="button" class="zoom-btn" id="zoomOut" disabled>‚àí</button>
        <span class="zoom-level">100%</span>
        <button type="button" class="zoom-btn" id="zoomIn" disabled>+</button>
    </div>
    <div class="crop-tools" id="cropTools" style="display:none;">
        <button type="button" class="control-btn" id="startCropBtn" disabled>
            ‚úÇÔ∏è –í—ã–¥–µ–ª–∏—Ç—å –æ–±–ª–∞—Å—Ç—å –∏–∑–¥–µ–ª–∏—è
        </button>
        <button type="button" class="control-btn control-btn-success" id="applyCropBtn" style="display:none;">
            ‚úì –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
        </button>
        <button type="button" class="control-btn control-btn-secondary" id="cancelCropBtn" style="display:none;">
            ‚úó –û—Ç–º–µ–Ω–∏—Ç—å
        </button>
    </div>
    <!-- –°–±—Ä–æ—Å -->
    <button type="button" class="control-btn control-btn-secondary" id="resetPosition" disabled>
        üîÑ –°–±—Ä–æ—Å–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é
    </button>
</div>
<!-- Undo/Redo –∫–æ–Ω—Ç—Ä–æ–ª—ã -->
<div class="undo-redo-controls">
    <button type="button" class="control-btn" id="undoBtn" disabled title="–û—Ç–º–µ–Ω–∏—Ç—å (Ctrl+Z)">
        ‚Ü∂ –û—Ç–º–µ–Ω–∏—Ç—å
    </button>
    <button type="button" class="control-btn" id="redoBtn" disabled title="–í–µ—Ä–Ω—É—Ç—å (Ctrl+Shift+Z)">
        ‚Ü∑ –í–µ—Ä–Ω—É—Ç—å
    </button>
</div>

<!-- üß≤ –ö–Ω–æ–ø–∫–∞ –º–∞–≥–Ω–∏—Ç–Ω–æ–≥–æ –ø—Ä–∏–ª–∏–ø–∞–Ω–∏—è -->
<div class="snap-controls">
    <button type="button" class="control-btn active" id="toggleSnapBtn" title="–ú–∞–≥–Ω–∏—Ç–Ω–æ–µ –ø—Ä–∏–ª–∏–ø–∞–Ω–∏–µ –∫ —ç—Ç–∞–ª–æ–Ω—É">
        üß≤ –ú–∞–≥–Ω–∏—Ç: –í–ö–õ
    </button>
</div>

<!-- üëÅÔ∏è –ö–Ω–æ–ø–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
<div class="preview-controls">
    <button type="button" class="control-btn control-btn-preview" id="previewBtn" disabled title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç">
        üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    </button>
</div>
                <!-- Canvas –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
                <div class="canvas-container-wrapper">
                    <!-- Canvas –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω —á–µ—Ä–µ–∑ JavaScript -->
                    <div class="loading-overlay">
                        <div class="spinner"></div>
                    </div>
                </div>
                
                <!-- –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã -->
                <div class="dimensions-display">
                    <h4>üìä –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∏–∑–¥–µ–ª–∏—è</h4>
                    <div class="dimension-row">
                        <span class="dimension-label">–®–∏—Ä–∏–Ω–∞:</span>
                        <span class="dimension-value calculated" id="calculatedWidth">‚Äî –º–º</span>
                    </div>
                    <div class="dimension-row">
                        <span class="dimension-label">–í—ã—Å–æ—Ç–∞:</span>
                        <span class="dimension-value calculated" id="calculatedHeight">‚Äî –º–º</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è —Ä–∞–∑–º–µ—Ä–æ–≤ -->
        <input type="hidden" id="id_width_mm" name="width_mm">
        <input type="hidden" id="id_height_mm" name="height_mm">
        <input type="hidden" id="id_diameter_mm" name="diameter_mm">
        <input type="hidden" id="id_editor_data" name="editor_data">
        
        <!-- –¶–µ–Ω–∞ –∏ —Å–∫–ª–∞–¥ -->
        <h3>–¶–µ–Ω–∞ –∏ —Å–∫–ª–∞–¥</h3>
        {{ form.price.label_tag }} {{ form.price }}
        {{ form.stock_quantity.label_tag }} {{ form.stock_quantity }}
        
        <!-- –°—Ç–∞—Ç—É—Å -->
        <h3>–°—Ç–∞—Ç—É—Å</h3>
        {{ form.is_active.label_tag }} {{ form.is_active }}
        {{ form.show_ruler }} {{ form.show_ruler.label_tag }}
        
        <button type="submit" class="btn">üíæ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
    </form>
    
    <a href="{% url 'catalog:factory_dashboard' %}" class="back-link">‚Üê –ù–∞–∑–∞–¥ –≤ –∫–∞–±–∏–Ω–µ—Ç</a>
</div>
{% endblock %}

{% block extra_js %}
<!-- Fabric.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<!-- –†–µ–¥–∞–∫—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
<script src="{% static 'js/image-editor.js' %}"></script>
<script>
// –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–∏–ø–∞
document.addEventListener('DOMContentLoaded', function() {
    console.log('–Æ–≤–µ–ª–∏—Ä–Ω—ã–π –ö–∞—Ç–∞–ª–æ–≥ –∑–∞–≥—Ä—É–∂–µ–Ω! üíé');
    
    const referenceTypeSelect = document.querySelector('[name="reference_photo_type"]');
    const editorSection = document.getElementById('editorSection');
    const referenceInfo = document.getElementById('referenceInfo');
    
    // –≠—Ç–∞–ª–æ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∏—Ö —Ä–∞–∑–º–µ—Ä—ã
    const referenceData = {
        'ear': {
            name: 'üëÇ –£—Ö–æ',
            image: '{% static "images/references/ear.png" %}',
            width: 50,
            height: 60,
            description: '–≠—Ç–∞–ª–æ–Ω–Ω–æ–µ —É—Ö–æ (50√ó60 –º–º)'
        },
        'finger': {
            name: 'üíç –ü–∞–ª–µ—Ü',
            image: '{% static "images/references/finger.png" %}',
            width: 17,
            height: 50,
            description: '–≠—Ç–∞–ª–æ–Ω–Ω—ã–π –ø–∞–ª–µ—Ü (–¥–∏–∞–º–µ—Ç—Ä 17 –º–º, –¥–ª–∏–Ω–∞ 50 –º–º)'
        },
        'wrist': {
            name: '‚åö –ó–∞–ø—è—Å—Ç—å–µ',
            image: '{% static "images/references/wrist.png" %}',
            width: 160,
            height: 60,
            description: '–≠—Ç–∞–ª–æ–Ω–Ω–æ–µ –∑–∞–ø—è—Å—Ç—å–µ (–æ–±—Ö–≤–∞—Ç 160 –º–º)'
        },
        'neck': {
            name: 'üìø –®–µ—è',
            image: '{% static "images/references/neck.png" %}',
            width: 360,
            height: 100,
            description: '–≠—Ç–∞–ª–æ–Ω–Ω–∞—è —à–µ—è (–æ–±—Ö–≤–∞—Ç 360 –º–º)'
        }
    };
    
    // üîß –§–ò–ö–°: –§—É–Ω–∫—Ü–∏—è –ø–æ–ª–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    function destroyEditor() {
        if (window.jewelryEditor) {
            console.log('üóëÔ∏è –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä...');
            
            // –£–¥–∞–ª—è–µ–º canvas instance
            if (window.jewelryEditor.canvas) {
                try {
                    window.jewelryEditor.canvas.dispose();
                    window.jewelryEditor.canvas = null;
                } catch (e) {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ canvas:', e);
                }
            }
            
            // –£–¥–∞–ª—è–µ–º DOM —ç–ª–µ–º–µ–Ω—Ç—ã
            const canvasContainer = document.querySelector('.canvas-container');
            if (canvasContainer) {
                canvasContainer.remove();
            }
            
            const oldCanvas = document.getElementById('fabricCanvas');
            if (oldCanvas) {
                oldCanvas.remove();
            }
            
            // –û—á–∏—â–∞–µ–º –≤—Å–µ —Å—Å—ã–ª–∫–∏
            window.jewelryEditor.referenceImg = null;
            window.jewelryEditor.productImg = null;
            window.jewelryEditor.cropRect = null;
            window.jewelryEditor.history = [];
            window.jewelryEditor.historyStep = -1;
            window.jewelryEditor = null;
            
            console.log('‚úÖ –†–µ–¥–∞–∫—Ç–æ—Ä —É–¥–∞–ª—ë–Ω');
        }
    }
    
    if (referenceTypeSelect) {
        referenceTypeSelect.addEventListener('change', function() {
            const selectedType = this.value;
            
            if (selectedType && selectedType !== 'none' && referenceData[selectedType]) {
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä
                destroyEditor();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
                editorSection.classList.remove('hidden');
                referenceInfo.style.display = 'block';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —ç—Ç–∞–ª–æ–Ω–µ
                const ref = referenceData[selectedType];
                document.getElementById('referenceTypeText').textContent = ref.name;
                document.getElementById('referenceSizeText').textContent = ref.description;
                
                // üîß –§–ò–ö–°: –ñ–¥—ë–º –ø–æ–∫–∞ —Å–µ–∫—Ü–∏—è —Å—Ç–∞–Ω–µ—Ç –≤–∏–¥–∏–º–æ–π
                setTimeout(() => {
                    console.log('üÜï –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è —Ç–∏–ø–∞:', selectedType);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∏–¥–∏–º
                    const container = document.getElementById('imageEditorContainer');
                    if (container && container.offsetWidth > 0) {
                        window.jewelryEditor = new JewelryImageEditor('imageEditorContainer', {
                            referenceImage: ref.image,
                            referenceWidth: ref.width,
                            referenceHeight: ref.height
                        });
                        
                        // üîß –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è crop –∫–Ω–æ–ø–∫–∏
                        const originalLoadProductImage = window.jewelryEditor.loadProductImage.bind(window.jewelryEditor);
                        window.jewelryEditor.loadProductImage = function(file) {
                            originalLoadProductImage(file);
                            
                            // –í–∫–ª—é—á–∞–µ–º crop –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                            const cropTools = document.getElementById('cropTools');
                            const startCropBtn = document.getElementById('startCropBtn');
                            if (cropTools) cropTools.style.display = 'flex';
                            if (startCropBtn) startCropBtn.disabled = false;
                        };
                        
                        console.log('‚úÖ –ù–æ–≤—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å–æ–∑–¥–∞–Ω');
                    } else {
                        console.error('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –Ω–µ –≤–∏–¥–µ–Ω –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    }
                }, 300); // –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
                
            } else {
                // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
                editorSection.classList.add('hidden');
                referenceInfo.style.display = 'none';
                
                // –£–¥–∞–ª—è–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
                destroyEditor();
            }
        });
    }
});
</script>
{% endblock %}