{% extends 'catalog/base.html' %}
{% load static %}

{% block title %}Добавить товар{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/image-editor.css' %}">
{% endblock %}

{% block header_title %}<i class="bi bi-plus-circle-fill"></i> Добавить новый товар{% endblock %}

{% block content %}
<div class="form-box">
    <h2>Добавление товара</h2>
    
    <form method="post" enctype="multipart/form-data" data-editor-form>
        {% csrf_token %}
        
        <!-- Основная информация -->
        <h3>Основная информация</h3>
        {{ form.category.label_tag }} {{ form.category }}
        {{ form.material.label_tag }} {{ form.material }}
        {{ form.name.label_tag }} {{ form.name }}
        {{ form.article.label_tag }} {{ form.article }}
        {{ form.description.label_tag }} {{ form.description }}
        
        <!-- Характеристики -->
        <h3>Характеристики металла</h3>
        {{ form.purity.label_tag }} {{ form.purity }}
        {{ form.metal_color.label_tag }} {{ form.metal_color }}
        {{ form.style.label_tag }} {{ form.style }}

        <h3>Вес и размеры</h3>
        {{ form.metal_weight.label_tag }} {{ form.metal_weight }}
        <span class="help-text">{{ form.metal_weight.help_text }}</span>

        {{ form.total_weight.label_tag }} {{ form.total_weight }}
        <span class="help-text">{{ form.total_weight.help_text }}</span>

        {{ form.size.label_tag }} {{ form.size }}

        <h3>Вставки и покрытия</h3>
        {{ form.has_inserts.label_tag }} {{ form.has_inserts }}

        <div id="insertTypesSection" style="display:none;">
            {{ form.insert_types.label_tag }}
            {{ form.insert_types }}
        </div>

        {{ form.insert_description.label_tag }} {{ form.insert_description }}

        {{ form.coatings.label_tag }} {{ form.coatings }}

        {{ form.has_stamp.label_tag }} {{ form.has_stamp }}

        <div id="stampDescSection" style="display:none;">
            {{ form.stamp_description.label_tag }} {{ form.stamp_description }}
        </div>
        
        <!-- Выбор типа изделия -->
        <h3><i class="bi bi-rulers"></i> Тип изделия</h3>
        <div class="form-group">
            {{ form.reference_photo_type.label_tag }}
            {{ form.reference_photo_type }}
            <p class="help-text">Выберите тип для автоматического расчёта размеров</p>
        </div>
        
        <!-- Редактор изображений (показывается только если выбран тип) -->
        <div id="editorSection" class="hidden">
            <h3><i class="bi bi-bounding-box"></i> Подгонка изделия под эталон</h3>
            
            <div class="image-editor-container" 
                 id="imageEditorContainer"
                 data-reference-image=""
                 data-reference-width="50"
                 data-reference-height="60">
                
                <!-- Инструкция -->
                <div class="editor-instructions">
                    <h4>Как подогнать изделие:</h4>
                    <ul>
                        <li>Загрузите фото вашего изделия</li>
                        <li>Перетаскивайте и масштабируйте его мышкой</li>
                        <li>Подгоните под эталон для точных размеров</li>
                        <li>Размеры рассчитаются автоматически</li>
                    </ul>
                </div>
                
                <!-- Информация об эталоне -->
                <div class="reference-info" id="referenceInfo" style="display:none;">
                    <strong>Эталон:</strong> <span id="referenceTypeText"></span><br>
                    <strong>Размеры эталона:</strong> <span id="referenceSizeText"></span>
                </div>
                
                <!-- Контролы -->
                <div class="editor-controls">
    <!-- Загрузка изделия -->
    <div class="file-upload">
        <input type="file" id="productImageInput" accept="image/*">
        <label for="productImageInput" class="file-upload-btn">
            <i class="bi bi-upload"></i> Загрузить фото изделия
        </label>
    </div>
    
    <!-- Прозрачность эталона -->
    <div class="control-group">
        <label for="referenceOpacity">Прозрачность эталона:</label>
        <input type="range" 
               id="referenceOpacity" 
               class="opacity-slider"
               min="0" 
               max="1" 
               step="0.1" 
               value="0.5">
    </div>
    
    <!-- НОВЫЙ: Прозрачность изделия -->
    <div class="control-group">
        <label for="productOpacity">Прозрачность изделия:</label>
        <input type="range" 
               id="productOpacity" 
               class="opacity-slider"
               min="0" 
               max="1" 
               step="0.1" 
               value="1"
               disabled>
        <span class="opacity-value">100%</span>
    </div>
    
    <!-- Zoom контролы -->
    <div class="zoom-controls">
        <button type="button" class="zoom-btn" id="zoomOut" disabled>−</button>
        <span class="zoom-level">100%</span>
        <button type="button" class="zoom-btn" id="zoomIn" disabled>+</button>
    </div>
    <div class="crop-tools" id="cropTools" style="display:none;">
        <button type="button" class="control-btn" id="startCropBtn" disabled>
            <i class="bi bi-scissors"></i> Выделить область изделия
        </button>
        <button type="button" class="control-btn control-btn-success" id="applyCropBtn" style="display:none;">
            <i class="bi bi-check-lg"></i> Применить выделение
        </button>
        <button type="button" class="control-btn control-btn-secondary" id="cancelCropBtn" style="display:none;">
            <i class="bi bi-x-lg"></i> Отменить
        </button>
    </div>
    <!-- Сброс -->
    <button type="button" class="control-btn control-btn-secondary" id="resetPosition" disabled>
        <i class="bi bi-arrow-counterclockwise"></i> Сбросить позицию
    </button>
</div>
<!-- Undo/Redo контролы -->
<div class="undo-redo-controls">
    <button type="button" class="control-btn" id="undoBtn" disabled title="Отменить (Ctrl+Z)">
        <i class="bi bi-arrow-counterclockwise"></i> Отменить
    </button>
    <button type="button" class="control-btn" id="redoBtn" disabled title="Вернуть (Ctrl+Shift+Z)">
        <i class="bi bi-arrow-clockwise"></i> Вернуть
    </button>
</div>

<!-- Кнопка магнитного прилипания -->
<div class="snap-controls">
    <button type="button" class="control-btn active" id="toggleSnapBtn" title="Магнитное прилипание к эталону">
        <i class="bi bi-magnet"></i> Магнит: ВКЛ
    </button>
</div>

<!-- Кнопка предпросмотра -->
<div class="preview-controls">
    <button type="button" class="control-btn control-btn-preview" id="previewBtn" disabled title="Посмотреть финальный результат">
        <i class="bi bi-eye"></i> Предпросмотр
    </button>
</div>
                <!-- Canvas контейнер -->
                <div class="canvas-container-wrapper">
                    <!-- Canvas будет создан через JavaScript -->
                    <div class="loading-overlay">
                        <div class="spinner"></div>
                    </div>
                </div>
                
                <!-- Рассчитанные размеры -->
                <div class="dimensions-display">
                    <h4><i class="bi bi-calculator"></i> Рассчитанные размеры изделия</h4>
                    <div class="dimension-row">
                        <span class="dimension-label">Ширина:</span>
                        <span class="dimension-value calculated" id="calculatedWidth">— мм</span>
                    </div>
                    <div class="dimension-row">
                        <span class="dimension-label">Высота:</span>
                        <span class="dimension-value calculated" id="calculatedHeight">— мм</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Скрытые поля для размеров -->
        <input type="hidden" id="id_width_mm" name="width_mm">
        <input type="hidden" id="id_height_mm" name="height_mm">
        <input type="hidden" id="id_diameter_mm" name="diameter_mm">
        <input type="hidden" id="id_editor_data" name="editor_data">
        
        <!-- Цена и склад -->
        <h3>Цена и склад</h3>
        {{ form.price.label_tag }} {{ form.price }}
        {{ form.stock_quantity.label_tag }} {{ form.stock_quantity }}
        
        <!-- Статус -->
        <h3>Статус</h3>
        {{ form.is_active.label_tag }} {{ form.is_active }}
        {{ form.show_ruler }} {{ form.show_ruler.label_tag }}
        
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-save"></i> Добавить товар
        </button>
    </form>

    <a href="{% url 'catalog:factory_dashboard' %}" class="back-link">
        <i class="bi bi-arrow-left"></i> Назад в кабинет
    </a>
</div>
{% endblock %}

{% block extra_js %}
<!-- Fabric.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<!-- Редактор изображений -->
<script src="{% static 'js/image-editor.js' %}"></script>
<script>
// Показ/скрытие редактора при выборе типа
document.addEventListener('DOMContentLoaded', function() {
    console.log('Ювелирный Каталог загружен! 💎');

    // 🔧 НОВОЕ: Показ/скрытие секции вставок
    const hasInsertsCheckbox = document.querySelector('[name="has_inserts"]');
    const insertTypesSection = document.getElementById('insertTypesSection');

    if (hasInsertsCheckbox && insertTypesSection) {
        hasInsertsCheckbox.addEventListener('change', function() {
            insertTypesSection.style.display = this.checked ? 'block' : 'none';
        });
        // Инициализация при загрузке
        insertTypesSection.style.display = hasInsertsCheckbox.checked ? 'block' : 'none';
    }

    // 🔧 НОВОЕ: Показ/скрытие описания клейма
    const hasStampCheckbox = document.querySelector('[name="has_stamp"]');
    const stampDescSection = document.getElementById('stampDescSection');

    if (hasStampCheckbox && stampDescSection) {
        hasStampCheckbox.addEventListener('change', function() {
            stampDescSection.style.display = this.checked ? 'block' : 'none';
        });
        // Инициализация при загрузке
        stampDescSection.style.display = hasStampCheckbox.checked ? 'block' : 'none';
    }

    const referenceTypeSelect = document.querySelector('[name="reference_photo_type"]');
    const editorSection = document.getElementById('editorSection');
    const referenceInfo = document.getElementById('referenceInfo');
    
    // Эталонные изображения и их размеры
    const referenceData = {
        'ear': {
            name: '👂 Ухо',
            image: '{% static "images/references/ear.png" %}',
            width: 50,
            height: 60,
            description: 'Эталонное ухо (50×60 мм)'
        },
        'finger': {
            name: '💍 Палец',
            image: '{% static "images/references/finger.png" %}',
            width: 17,
            height: 50,
            description: 'Эталонный палец (диаметр 17 мм, длина 50 мм)'
        },
        'wrist': {
            name: '⌚ Запястье',
            image: '{% static "images/references/wrist.png" %}',
            width: 160,
            height: 60,
            description: 'Эталонное запястье (обхват 160 мм)'
        },
        'neck': {
            name: '📿 Шея',
            image: '{% static "images/references/neck.png" %}',
            width: 360,
            height: 100,
            description: 'Эталонная шея (обхват 360 мм)'
        }
    };
    
    // 🔧 ФИКС: Функция полного удаления редактора
    function destroyEditor() {
        if (window.jewelryEditor) {
            console.log('🗑️ Удаляем старый редактор...');
            
            // Удаляем canvas instance
            if (window.jewelryEditor.canvas) {
                try {
                    window.jewelryEditor.canvas.dispose();
                    window.jewelryEditor.canvas = null;
                } catch (e) {
                    console.warn('Ошибка при удалении canvas:', e);
                }
            }
            
            // Удаляем DOM элементы
            const canvasContainer = document.querySelector('.canvas-container');
            if (canvasContainer) {
                canvasContainer.remove();
            }
            
            const oldCanvas = document.getElementById('fabricCanvas');
            if (oldCanvas) {
                oldCanvas.remove();
            }
            
            // Очищаем все ссылки
            window.jewelryEditor.referenceImg = null;
            window.jewelryEditor.productImg = null;
            window.jewelryEditor.cropRect = null;
            window.jewelryEditor.history = [];
            window.jewelryEditor.historyStep = -1;
            window.jewelryEditor = null;
            
            console.log('✅ Редактор удалён');
        }
    }
    
    if (referenceTypeSelect) {
        referenceTypeSelect.addEventListener('change', function() {
            const selectedType = this.value;
            
            if (selectedType && selectedType !== 'none' && referenceData[selectedType]) {
                // Удаляем старый редактор
                destroyEditor();
                
                // Показываем редактор
                editorSection.classList.remove('hidden');
                referenceInfo.style.display = 'block';
                
                // Обновляем информацию об эталоне
                const ref = referenceData[selectedType];
                document.getElementById('referenceTypeText').textContent = ref.name;
                document.getElementById('referenceSizeText').textContent = ref.description;
                
                // 🔧 ФИКС: Ждём пока секция станет видимой
                setTimeout(() => {
                    console.log('🆕 Создаём новый редактор для типа:', selectedType);
                    
                    // Проверяем что контейнер видим
                    const container = document.getElementById('imageEditorContainer');
                    if (container && container.offsetWidth > 0) {
                        window.jewelryEditor = new JewelryImageEditor('imageEditorContainer', {
                            referenceImage: ref.image,
                            referenceWidth: ref.width,
                            referenceHeight: ref.height
                        });
                        
                        // 🔧 Подключаем обработчик загрузки файла для включения crop кнопки
                        const originalLoadProductImage = window.jewelryEditor.loadProductImage.bind(window.jewelryEditor);
                        window.jewelryEditor.loadProductImage = function(file) {
                            originalLoadProductImage(file);
                            
                            // Включаем crop кнопку после загрузки
                            const cropTools = document.getElementById('cropTools');
                            const startCropBtn = document.getElementById('startCropBtn');
                            if (cropTools) cropTools.style.display = 'flex';
                            if (startCropBtn) startCropBtn.disabled = false;
                        };
                        
                        console.log('✅ Новый редактор создан');
                    } else {
                        console.error('❌ Контейнер редактора не виден или не найден');
                    }
                }, 300); // Увеличенная задержка для надёжности
                
            } else {
                // Скрываем редактор
                editorSection.classList.add('hidden');
                referenceInfo.style.display = 'none';
                
                // Удаляем редактор
                destroyEditor();
            }
        });
    }
});
</script>
{% endblock %}