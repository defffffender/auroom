{% extends 'catalog/base.html' %}
{% load static %}

{% block title %}{{ product.name }} - {{ product.article }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/product.css' %}">
<link rel="stylesheet" href="{% static 'css/ruler.css' %}">
{% endblock %}

{% block content %}
<!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
<div class="breadcrumbs">
    <a href="{% url 'catalog:home' %}">–ì–ª–∞–≤–Ω–∞—è</a> / 
    <a href="{% url 'catalog:home' %}?category={{ product.category.slug }}">{{ product.category.name }}</a> / 
    {{ product.name }}
</div>

<!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
<div class="product-main">
    <!-- –ì–∞–ª–µ—Ä–µ—è -->
    <div class="gallery">
        {% if product.images.all %}
            {% if product.show_ruler and product.has_dimensions %}
                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ª–∏–Ω–µ–π–∫–∏ -->
                <div id="jewelryRulerContainer" class="ruler-container"
                     data-width-mm="{{ product.width_mm }}"
                     data-height-mm="{{ product.height_mm }}"
                     data-diameter-mm="{{ product.diameter_mm }}"
                     data-reference-type="{{ product.reference_photo_type }}"
                     data-editor-data="{{ product.editor_data|escapejs }}">
                    
                    {% if product.reference_photo_type != 'none' %}
                        <div class="reference-badge">
                            üìè –≠—Ç–∞–ª–æ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ –¥–ª—è —Ç–æ—á–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
                        </div>
                    {% endif %}
                    
                    <div class="ruler-image-wrapper">
                        <img src="{{ product.images.all.0.image.url }}" 
                             alt="{{ product.name }}" 
                             class="ruler-image" 
                             id="mainImage">
                    </div>
                </div>
            {% else %}
                <!-- –û–±—ã—á–Ω–∞—è –≥–∞–ª–µ—Ä–µ—è –±–µ–∑ –ª–∏–Ω–µ–π–∫–∏ -->
                <img src="{{ product.images.all.0.image.url }}" 
                     alt="{{ product.name }}" 
                     class="main-image" 
                     id="mainImage">
            {% endif %}
            
            {% if product.images.all|length > 1 %}
            <div class="thumbnails">
                {% for image in product.images.all %}
                    <img src="{{ image.image.url }}" 
                         alt="{{ product.name }}" 
                         class="thumbnail {% if forloop.first %}active{% endif %}" 
                         onclick="changeImage('{{ image.image.url }}', this)"
                         {% if image.is_reference %}title="üìè –≠—Ç–∞–ª–æ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ"{% endif %}>
                {% endfor %}
            </div>
            {% endif %}
        {% else %}
            <div class="main-image"></div>
        {% endif %}
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="product-detail-info">
        <h1>{{ product.name }}</h1>
        
        <div class="product-meta">
            <span class="category-badge">{{ product.category.name }}</span>
            <span class="meta-item">–ê—Ä—Ç–∏–∫—É–ª: <strong>{{ product.article }}</strong></span>
            <span class="meta-item">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: {{ product.views_count }}</span>
        </div>

        <div class="price">{{ product.price }} $</div>

        <!-- –ö–Ω–æ–ø–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ -->
        {% if user.is_authenticated %}
            <form action="{% url 'catalog:toggle_favorite' product.article %}" method="post">
                {% csrf_token %}
                {% if product in user.favorites.all %}
                    <button type="submit" class="btn btn-danger favorite-btn">
                        ‚ù§Ô∏è –£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
                    </button>
                {% else %}
                    <button type="submit" class="btn favorite-btn" style="background: #4caf50;">
                        ü§ç –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                    </button>
                {% endif %}
            </form>
        {% else %}
            <a href="{% url 'catalog:login' %}" class="btn favorite-btn">
                –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
            </a>
        {% endif %}

        {% if product.in_stock %}
            <div class="stock-status in-stock">
                ‚úì –í –Ω–∞–ª–∏—á–∏–∏ ({{ product.stock_quantity }} —à—Ç)
            </div>
        {% else %}
            <div class="stock-status out-stock">
                ‚úó –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
            </div>
        {% endif %}

        <div class="description">
            <p>{{ product.description }}</p>
        </div>

        <!-- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
        <div class="specs">
            <h3>üìã –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h3>
            <div class="spec-row">
                <span class="spec-label">–ú–∞—Ç–µ—Ä–∏–∞–ª</span>
                <span class="spec-value">{{ product.material.name }}</span>
            </div>
            <div class="spec-row">
                <span class="spec-label">–í–µ—Å</span>
                <span class="spec-value">{{ product.weight }} –≥</span>
            </div>
            {% if product.size %}
            <div class="spec-row">
                <span class="spec-label">–†–∞–∑–º–µ—Ä</span>
                <span class="spec-value">{{ product.size }}</span>
            </div>
            {% endif %}
            
            <!-- –¢–æ—á–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã -->
            {% if product.has_dimensions %}
            <div class="spec-row">
                <span class="spec-label">üìê –†–∞–∑–º–µ—Ä—ã</span>
                <span class="spec-value">{{ product.dimensions_text }}</span>
            </div>
            {% endif %}
            
            {% if product.has_stones %}
            <div class="spec-row">
                <span class="spec-label">–í—Å—Ç–∞–≤–∫–∏</span>
                <span class="spec-value">{{ product.stone_description|default:"–ï—Å—Ç—å" }}</span>
            </div>
            {% endif %}
            <div class="spec-row">
                <span class="spec-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                <span class="spec-value">{{ product.category.name }}</span>
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–≤–æ–¥–µ -->
        <div class="factory-info">
            <div class="factory-header">
                {% if product.factory.logo %}
                    <img src="{{ product.factory.logo.url }}" alt="{{ product.factory.name }}" class="factory-logo">
                {% else %}
                    <div class="factory-logo"></div>
                {% endif %}
                <div>
                    <h3>{{ product.factory.name }}</h3>
                    {% if product.factory.is_verified %}
                    <span>‚úì –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</span>
                    {% endif %}
                </div>
            </div>
            <div class="factory-contacts">
                üìç {{ product.factory.address }}<br>
                üìû {{ product.factory.phone }}<br>
                ‚úâÔ∏è {{ product.factory.email }}
            </div>
            <a href="{% url 'catalog:factory_detail' product.factory.id %}" class="factory-link">
                –í—Å–µ —Ç–æ–≤–∞—Ä—ã –∑–∞–≤–æ–¥–∞ ‚Üí
            </a>
        </div>
    </div>
</div>

<!-- –ü–æ—Ö–æ–∂–∏–µ —Ç–æ–≤–∞—Ä—ã -->
{% if similar_products %}
<div class="similar-section">
    <h2>–ü–æ—Ö–æ–∂–∏–µ —Ç–æ–≤–∞—Ä—ã</h2>
    <div class="similar-grid">
        {% for similar in similar_products %}
            <a href="{% url 'catalog:product_detail' similar.article %}" class="similar-card">
                {% if similar.images.all.0 %}
                    <img src="{{ similar.images.all.0.image.url }}" alt="{{ similar.name }}" class="similar-image">
                {% else %}
                    <div class="similar-image"></div>
                {% endif %}
                <div class="similar-info">
                    <div class="similar-name">{{ similar.name }}</div>
                    <div class="similar-price">{{ similar.price }} $</div>
                </div>
            </a>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/ruler.js' %}"></script>
{% endblock %}