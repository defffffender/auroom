{% extends 'catalog/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ product.name }} - {% trans "Полноэкранный просмотр" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/ruler.css' %}">
<style>
    /* Убираем отступы для полноэкранного режима */
    main {
        padding: 0 !important;
        max-width: 100% !important;
    }

    .fullscreen-container {
        min-height: calc(100vh - 80px);
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f9fafb;
        position: relative;
    }

    /* Dark mode для fullscreen контейнера */
    .dark .fullscreen-container {
        background: #111827;
    }

    .fullscreen-image-wrapper {
        max-width: 90vw;
        max-height: 85vh;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .fullscreen-image {
        max-width: 100%;
        max-height: 85vh;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    .fullscreen-controls {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border-radius: 16px;
        padding: 12px;
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 8px;
        z-index: 100;
        width: auto;
    }

    /* Dark mode для контролов */
    .dark .fullscreen-controls {
        background: rgb(31 41 55);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
    }

    .fullscreen-info {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        color: #111827;
        padding: 15px 30px;
        border-radius: 16px;
        z-index: 100;
        text-align: center;
    }

    /* Dark mode для инфо блока */
    .dark .fullscreen-info {
        background: rgb(31 41 55);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
    }

    .control-btn {
        background: #f3f4f6;
        color: #374151;
        border: none;
        padding: 0;
        width: 56px;
        height: 56px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    /* Dark mode для кнопок */
    .dark .control-btn {
        background: rgb(55 65 81);
        color: rgb(209 213 219);
    }

    .control-btn:hover {
        background: #e5e7eb;
        transform: translateY(-2px);
    }

    /* Dark mode для hover кнопок */
    .dark .control-btn:hover {
        background: rgb(75 85 99);
    }

    .control-btn i {
        font-size: 24px;
    }

    /* Стиль для ссылки как кнопки */
    a.control-btn {
        text-decoration: none;
    }

    .thumbnail-gallery {
        position: fixed;
        bottom: 120px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(10px);
        padding: 10px;
        border-radius: 15px;
    }

    .thumbnail {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
        border: 3px solid transparent;
        transition: all 0.3s ease;
    }

    .thumbnail:hover {
        transform: scale(1.1);
        border-color: rgba(255, 255, 255, 0.5);
    }

    .thumbnail.active {
        border-color: #6366f1;
        transform: scale(1.15);
    }

    /* Ruler styles */
    .ruler-overlay {
        position: absolute;
        pointer-events: none;
        z-index: 50;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
    }

    .ruler-tool {
        position: absolute;
        cursor: move;
        pointer-events: auto;
        filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.3));
        transition: transform 0.1s ease;
    }

    .ruler-tool:hover {
        transform: scale(1.05);
    }

    .ruler-tool.active {
        filter: drop-shadow(0 6px 12px rgba(99, 102, 241, 0.5));
    }

    .control-btn.active {
        background: #6366f1;
        color: white;
    }

    /* Dark mode для активных кнопок */
    .dark .control-btn.active {
        background: #818cf8;
        color: white;
    }

    /* Адаптация стилей ruler для fullscreen */
    .ruler-image-wrapper {
        position: relative;
        display: inline-block;
        max-width: 100%;
    }

    #rulerCanvas {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
        z-index: 10;
    }

    /* Скрываем встроенные контролы JewelryRuler на fullscreen странице */
    #jewelryRulerContainer .ruler-controls,
    #jewelryRulerContainer .ruler-info,
    #jewelryRulerContainer .reference-info-ruler {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="fullscreen-container" id="fullscreenContainer">
    <!-- Product Info -->
    <div class="fullscreen-info">
        <h1 class="text-xl font-bold mb-1">{{ product.name }}</h1>
        <p class="text-sm opacity-80">
            <i class="bi bi-hash"></i> {{ product.article }} •
            <i class="bi bi-gem"></i> {{ product.material.name }}
            {% if product.purity %} • {{ product.purity.value }}{% endif %}
        </p>
    </div>

    <!-- Main Image -->
    <div class="fullscreen-image-wrapper" id="imageWrapper" style="position: relative;">
        {% if product.images.all %}
            <div id="jewelryRulerContainer"
                 data-width-mm="{{ product.width_mm }}"
                 data-height-mm="{{ product.height_mm }}"
                 data-diameter-mm="{{ product.diameter_mm }}"
                 data-reference-type="{{ product.reference_photo_type }}"
                 data-editor-data="{{ product.editor_data|escapejs }}"
                 style="position: relative; display: flex; align-items: center; justify-content: center;">

                <!-- Скрытые placeholder элементы для JewelryRuler -->
                <div style="display: none;">
                    <div id="toggleDrawModeBtn"></div>
                    <div id="toggleGridModeBtn"></div>
                    <div id="togglePerpendicularBtn"></div>
                    <div id="clearRulerBtn"></div>
                    <div id="drawModeInfo"></div>
                    <div id="drawStatus"></div>
                    <div id="gridModeInfo"></div>
                    <div id="gridDrawStatus"></div>
                    <div id="perpendicularInfo"></div>
                    <div id="coordinatesDisplay">
                        <span>X: <strong id="coordX">0</strong></span>
                        <span>Y: <strong id="coordY">0</strong></span>
                    </div>
                    <div id="perpendicularUp">0</div>
                    <div id="perpendicularRight">0</div>
                </div>

                <div class="ruler-image-wrapper">
                    <img src="{{ product.images.all.0.image.url }}"
                         alt="{{ product.name }}"
                         class="fullscreen-image ruler-image"
                         id="mainFullscreenImage"
                         loading="eager">

                    <!-- SVG Ruler Overlay -->
                    <div class="ruler-overlay" id="rulerOverlay">
                        <img src="{% static 'images/ruler.svg' %}"
                             alt="Линейка"
                             class="ruler-tool"
                             id="rulerTool"
                             style="width: 450px; top: 10%; left: 10%;">
                    </div>
                </div>
            </div>
        {% else %}
            <div class="text-white text-center">
                <i class="bi bi-image" style="font-size: 8rem; opacity: 0.5;"></i>
                <p class="mt-4 text-xl">{% trans "Изображение отсутствует" %}</p>
            </div>
        {% endif %}
    </div>

    <!-- Thumbnail Gallery (if multiple images) -->
    {% if product.images.all|length > 1 %}
    <div class="thumbnail-gallery">
        {% for image in product.images.all %}
            <img src="{{ image.image.url }}"
                 alt="{{ product.name }}"
                 class="thumbnail {% if forloop.first %}active{% endif %}"
                 onclick="changeFullscreenImage('{{ image.image.url }}', this)"
                 loading="lazy">
        {% endfor %}
    </div>
    {% endif %}

    <!-- Control Panel -->
    <div class="fullscreen-controls">
        <button onclick="toggleDrawMode()" class="control-btn" id="drawModeBtn" title="{% trans 'Рисование линий' %}">
            <i class="bi bi-pencil"></i>
        </button>

        <button onclick="toggleGridMode()" class="control-btn" id="gridModeBtn" title="{% trans 'Координаты' %}">
            <i class="bi bi-grid"></i>
        </button>

        <button onclick="togglePerpendicularMode()" class="control-btn" id="perpendicularModeBtn" title="{% trans 'Перпендикуляр' %}">
            <i class="bi bi-rulers"></i>
        </button>

        <button onclick="toggleRuler()" class="control-btn active" id="rulerBtn" title="{% trans 'Скрыть линейку' %}">
            <i class="bi bi-arrows-move"></i>
        </button>

        <button onclick="clearAllLines()" class="control-btn" id="clearBtn" style="opacity: 0.3; pointer-events: none;" title="{% trans 'Очистить' %}">
            <i class="bi bi-trash"></i>
        </button>

        <a href="{% url 'catalog:product_detail' product.article %}" class="control-btn" title="{% trans 'Назад к товару' %}">
            <i class="bi bi-x-lg"></i>
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/ruler.js' %}"></script>
<script>
let currentImageIndex = 0;
const images = [
    {% for image in product.images.all %}
    '{{ image.image.url }}'{% if not forloop.last %},{% endif %}
    {% endfor %}
];
let rulerInstance = null;

function changeFullscreenImage(url, thumbnail) {
    const mainImage = document.getElementById('mainFullscreenImage');
    mainImage.src = url;

    // Update active thumbnail
    document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
    thumbnail.classList.add('active');

    // Update current index
    currentImageIndex = Array.from(document.querySelectorAll('.thumbnail')).indexOf(thumbnail);

    // Reset zoom
    if (isZoomed) {
        toggleZoom();
    }
}

function previousImage() {
    if (images.length <= 1) return;

    currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
    const mainImage = document.getElementById('mainFullscreenImage');
    mainImage.src = images[currentImageIndex];

    // Update active thumbnail
    const thumbnails = document.querySelectorAll('.thumbnail');
    thumbnails.forEach((t, i) => {
        t.classList.toggle('active', i === currentImageIndex);
    });
}

function nextImage() {
    if (images.length <= 1) return;

    currentImageIndex = (currentImageIndex + 1) % images.length;
    const mainImage = document.getElementById('mainFullscreenImage');
    mainImage.src = images[currentImageIndex];

    // Update active thumbnail
    const thumbnails = document.querySelectorAll('.thumbnail');
    thumbnails.forEach((t, i) => {
        t.classList.toggle('active', i === currentImageIndex);
    });
}

// Drawing tools functions
function toggleDrawMode() {
    if (!rulerInstance) return;
    rulerInstance.toggleDrawMode();
    updateButtonState('drawModeBtn', rulerInstance.drawMode);
    updateClearButton();
}

function toggleGridMode() {
    if (!rulerInstance) return;
    rulerInstance.toggleGridMode();
    updateButtonState('gridModeBtn', rulerInstance.gridMode);
    updateClearButton();
}

function togglePerpendicularMode() {
    if (!rulerInstance) return;
    rulerInstance.togglePerpendicularMode();
    updateButtonState('perpendicularModeBtn', rulerInstance.perpendicularMode);
}

function clearAllLines() {
    if (!rulerInstance) return;
    rulerInstance.clearLines();
}

function updateButtonState(btnId, isActive) {
    const btn = document.getElementById(btnId);
    if (btn) {
        if (isActive) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    }
}

function updateClearButton() {
    const clearBtn = document.getElementById('clearBtn');
    if (clearBtn && rulerInstance) {
        const shouldShow = rulerInstance.drawMode || rulerInstance.gridMode;
        clearBtn.style.opacity = shouldShow ? '1' : '0.3';
        clearBtn.style.pointerEvents = shouldShow ? 'auto' : 'none';
    }
}

function downloadImage() {
    const mainImage = document.getElementById('mainFullscreenImage');
    const link = document.createElement('a');
    link.href = mainImage.src;
    link.download = '{{ product.name }}_{{ product.article }}.jpg';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Toggle SVG Ruler
let isRulerActive = true;

function toggleRuler() {
    const rulerOverlay = document.getElementById('rulerOverlay');
    const rulerBtn = document.getElementById('rulerBtn');

    isRulerActive = !isRulerActive;

    if (isRulerActive) {
        rulerOverlay.style.display = 'block';
        rulerBtn.classList.add('active');
        rulerBtn.title = '{% trans "Скрыть линейку" %}';
        initRulerDrag();
    } else {
        rulerOverlay.style.display = 'none';
        rulerBtn.classList.remove('active');
        rulerBtn.title = '{% trans "Показать линейку" %}';
    }
}

// Initialize Ruler Dragging
let rulerDragInitialized = false;
let rulerState = {
    isDragging: false,
    currentX: 0,
    currentY: 0,
    initialX: 0,
    initialY: 0,
    xOffset: 0,
    yOffset: 0
};

function initRulerDrag() {
    if (rulerDragInitialized) return;

    const ruler = document.getElementById('rulerTool');

    function dragStart(e) {
        if (e.target !== ruler) return;
        e.preventDefault();

        if (e.type === 'touchstart') {
            rulerState.initialX = e.touches[0].clientX - rulerState.xOffset;
            rulerState.initialY = e.touches[0].clientY - rulerState.yOffset;
        } else {
            rulerState.initialX = e.clientX - rulerState.xOffset;
            rulerState.initialY = e.clientY - rulerState.yOffset;
        }

        rulerState.isDragging = true;
        ruler.classList.add('active');
    }

    function drag(e) {
        if (!rulerState.isDragging) return;
        e.preventDefault();

        if (e.type === 'touchmove') {
            rulerState.currentX = e.touches[0].clientX - rulerState.initialX;
            rulerState.currentY = e.touches[0].clientY - rulerState.initialY;
        } else {
            rulerState.currentX = e.clientX - rulerState.initialX;
            rulerState.currentY = e.clientY - rulerState.initialY;
        }

        rulerState.xOffset = rulerState.currentX;
        rulerState.yOffset = rulerState.currentY;

        setRulerPosition(rulerState.currentX, rulerState.currentY);
    }

    function dragEnd(e) {
        rulerState.isDragging = false;
        ruler.classList.remove('active');
    }

    function setRulerPosition(xPos, yPos) {
        ruler.style.left = `calc(10% + ${xPos}px)`;
        ruler.style.top = `calc(10% + ${yPos}px)`;
        ruler.style.transform = 'translate(-50%, -50%)';
    }

    // Mouse events
    ruler.addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', dragEnd);

    // Touch events
    ruler.addEventListener('touchstart', dragStart, { passive: false });
    document.addEventListener('touchmove', drag, { passive: false });
    document.addEventListener('touchend', dragEnd);

    rulerDragInitialized = true;
}


// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') {
        previousImage();
    } else if (e.key === 'ArrowRight') {
        nextImage();
    } else if (e.key === 'Escape') {
        window.location.href = '{% url "catalog:product_detail" product.article %}';
    } else if (e.key === 'd' || e.key === 'D') {
        toggleDrawMode();
    } else if (e.key === 'g' || e.key === 'G') {
        toggleGridMode();
    } else if (e.key === 'p' || e.key === 'P') {
        togglePerpendicularMode();
    } else if (e.key === 'r' || e.key === 'R') {
        toggleRuler();
    } else if (e.key === 'c' || e.key === 'C') {
        clearAllLines();
    }
});

// Initialize JewelryRuler on page load
document.addEventListener('DOMContentLoaded', function() {
    const rulerContainer = document.getElementById('jewelryRulerContainer');

    if (rulerContainer) {
        rulerInstance = new JewelryRuler('jewelryRulerContainer', {
            widthMm: parseFloat(rulerContainer.dataset.widthMm) || null,
            heightMm: parseFloat(rulerContainer.dataset.heightMm) || null,
            diameterMm: parseFloat(rulerContainer.dataset.diameterMm) || null,
            referenceType: rulerContainer.dataset.referenceType || 'none',
            editorData: rulerContainer.dataset.editorData || null
        });

        console.log('JewelryRuler initialized:', rulerInstance);
    }

    // Initialize SVG ruler drag
    initRulerDrag();
});
</script>
{% endblock %}
